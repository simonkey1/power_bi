<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Simon Gomez">
<meta name="description" content="Un tutorial de cÃ³mo extraer datos con Playwright, procesarlos con Pandas y visualizar en PowerBI.">

<title>âš¡ AnÃ¡lisis en Tiempo Real del Suministro ElÃ©ctrico de Chile âš¡</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introducciÃ³n" id="toc-introducciÃ³n" class="nav-link active" data-scroll-target="#introducciÃ³n">IntroducciÃ³n</a></li>
  <li><a href="#quÃ©-haremos" id="toc-quÃ©-haremos" class="nav-link" data-scroll-target="#quÃ©-haremos">Â¿QuÃ© haremos?</a></li>
  <li><a href="#aclaraciÃ³n" id="toc-aclaraciÃ³n" class="nav-link" data-scroll-target="#aclaraciÃ³n">AclaraciÃ³n ğŸ”´</a></li>
  <li><a href="#entorno-de-desarrollo" id="toc-entorno-de-desarrollo" class="nav-link" data-scroll-target="#entorno-de-desarrollo">Entorno de Desarrollo</a></li>
  <li><a href="#extracciÃ³n-de-los-datos" id="toc-extracciÃ³n-de-los-datos" class="nav-link" data-scroll-target="#extracciÃ³n-de-los-datos">ExtracciÃ³n de los Datos</a></li>
  <li><a href="#instalar-dependencias" id="toc-instalar-dependencias" class="nav-link" data-scroll-target="#instalar-dependencias">ğŸš€ Instalar Dependencias</a>
  <ul class="collapse">
  <li><a href="#extracciÃ³n-de-datos-con-playwright" id="toc-extracciÃ³n-de-datos-con-playwright" class="nav-link" data-scroll-target="#extracciÃ³n-de-datos-con-playwright">ğŸ” ExtracciÃ³n de Datos con Playwright</a>
  <ul class="collapse">
  <li><a href="#importaciÃ³n-de-librerÃ­as" id="toc-importaciÃ³n-de-librerÃ­as" class="nav-link" data-scroll-target="#importaciÃ³n-de-librerÃ­as">ğŸ“Œ ImportaciÃ³n de LibrerÃ­as</a></li>
  </ul></li>
  <li><a href="#definiciÃ³n-de-archivos-de-salida" id="toc-definiciÃ³n-de-archivos-de-salida" class="nav-link" data-scroll-target="#definiciÃ³n-de-archivos-de-salida">ğŸ“‚ DefiniciÃ³n de Archivos de Salida</a></li>
  </ul></li>
  <li><a href="#anÃ¡lisis-de-la-funciÃ³n-intercept_responses" id="toc-anÃ¡lisis-de-la-funciÃ³n-intercept_responses" class="nav-link" data-scroll-target="#anÃ¡lisis-de-la-funciÃ³n-intercept_responses">ğŸ” AnÃ¡lisis de la FunciÃ³n <code>intercept_responses()</code></a>
  <ul class="collapse">
  <li><a href="#estructura-general" id="toc-estructura-general" class="nav-link" data-scroll-target="#estructura-general">ğŸ“Œ <strong>Estructura General</strong></a></li>
  <li><a href="#paso-a-paso-de-la-funciÃ³n" id="toc-paso-a-paso-de-la-funciÃ³n" class="nav-link" data-scroll-target="#paso-a-paso-de-la-funciÃ³n">ğŸ›  <strong>Paso a Paso de la FunciÃ³n</strong></a>
  <ul class="collapse">
  <li><a href="#inicializar-playwright-y-abrir-el-navegador" id="toc-inicializar-playwright-y-abrir-el-navegador" class="nav-link" data-scroll-target="#inicializar-playwright-y-abrir-el-navegador">1ï¸âƒ£ <strong>Inicializar Playwright y Abrir el Navegador</strong></a></li>
  <li><a href="#definir-una-lista-para-almacenar-registros" id="toc-definir-una-lista-para-almacenar-registros" class="nav-link" data-scroll-target="#definir-una-lista-para-almacenar-registros">2ï¸âƒ£ <strong>Definir una Lista para Almacenar Registros</strong></a></li>
  <li><a href="#interceptar-las-respuestas-de-la-api" id="toc-interceptar-las-respuestas-de-la-api" class="nav-link" data-scroll-target="#interceptar-las-respuestas-de-la-api">3ï¸âƒ£ <strong>Interceptar las Respuestas de la API</strong></a></li>
  <li><a href="#procesar-los-datos-extraÃ­dos" id="toc-procesar-los-datos-extraÃ­dos" class="nav-link" data-scroll-target="#procesar-los-datos-extraÃ­dos">4ï¸âƒ£ <strong>Procesar los Datos ExtraÃ­dos</strong></a></li>
  <li><a href="#crear-un-identificador-Ãºnico-para-cada-registro" id="toc-crear-un-identificador-Ãºnico-para-cada-registro" class="nav-link" data-scroll-target="#crear-un-identificador-Ãºnico-para-cada-registro">5ï¸âƒ£ <strong>Crear un Identificador Ãšnico para Cada Registro</strong></a></li>
  <li><a href="#guardar-los-datos-en-la-lista-registros" id="toc-guardar-los-datos-en-la-lista-registros" class="nav-link" data-scroll-target="#guardar-los-datos-en-la-lista-registros">6ï¸âƒ£ <strong>Guardar los Datos en la Lista <code>registros</code></strong></a></li>
  <li><a href="#capturar-las-respuestas-de-la-api" id="toc-capturar-las-respuestas-de-la-api" class="nav-link" data-scroll-target="#capturar-las-respuestas-de-la-api">7ï¸âƒ£ <strong>Capturar las Respuestas de la API</strong></a></li>
  <li><a href="#acceder-a-la-pÃ¡gina-de-la-sec" id="toc-acceder-a-la-pÃ¡gina-de-la-sec" class="nav-link" data-scroll-target="#acceder-a-la-pÃ¡gina-de-la-sec">8ï¸âƒ£ <strong>Acceder a la PÃ¡gina de la SEC</strong></a></li>
  <li><a href="#cerrar-el-navegador" id="toc-cerrar-el-navegador" class="nav-link" data-scroll-target="#cerrar-el-navegador">9ï¸âƒ£ <strong>Cerrar el Navegador</strong></a></li>
  </ul></li>
  <li><a href="#guardado-de-datos-en-csv" id="toc-guardado-de-datos-en-csv" class="nav-link" data-scroll-target="#guardado-de-datos-en-csv">ğŸ“Š <strong>Guardado de Datos en CSV</strong></a></li>
  <li><a href="#automatizaciÃ³n-cada-5-minutos" id="toc-automatizaciÃ³n-cada-5-minutos" class="nav-link" data-scroll-target="#automatizaciÃ³n-cada-5-minutos">ğŸ” <strong>AutomatizaciÃ³n Cada 5 Minutos</strong></a></li>
  <li><a href="#extra" id="toc-extra" class="nav-link" data-scroll-target="#extra">Extra</a>
  <ul class="collapse">
  <li><a href="#felicidades" id="toc-felicidades" class="nav-link" data-scroll-target="#felicidades">Felicidadesâ­!</a></li>
  <li><a href="#aclaraciÃ³n-1" id="toc-aclaraciÃ³n-1" class="nav-link" data-scroll-target="#aclaraciÃ³n-1">AclaraciÃ³n ğŸ”´</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#powerbi-transformaciÃ³n-y-visualizaciÃ³n-de-los-datos" id="toc-powerbi-transformaciÃ³n-y-visualizaciÃ³n-de-los-datos" class="nav-link" data-scroll-target="#powerbi-transformaciÃ³n-y-visualizaciÃ³n-de-los-datos">Powerbi: transformaciÃ³n y VisualizaciÃ³n de los datos</a></li>
  <li><a href="#cÃ³digo-m" id="toc-cÃ³digo-m" class="nav-link" data-scroll-target="#cÃ³digo-m">CÃ³digo M</a>
  <ul class="collapse">
  <li><a href="#explicaciÃ³n-del-cÃ³digo-m" id="toc-explicaciÃ³n-del-cÃ³digo-m" class="nav-link" data-scroll-target="#explicaciÃ³n-del-cÃ³digo-m">ExplicaciÃ³n del cÃ³digo M</a></li>
  <li><a href="#cargar-el-archivo-csv-y-promover-encabezados" id="toc-cargar-el-archivo-csv-y-promover-encabezados" class="nav-link" data-scroll-target="#cargar-el-archivo-csv-y-promover-encabezados">ğŸ“Œ Cargar el Archivo CSV y Promover Encabezados</a></li>
  <li><a href="#cambiar-tipos-de-datos" id="toc-cambiar-tipos-de-datos" class="nav-link" data-scroll-target="#cambiar-tipos-de-datos">ğŸ“Œ Cambiar Tipos de Datos</a></li>
  <li><a href="#agregar-una-columna-personalizada" id="toc-agregar-una-columna-personalizada" class="nav-link" data-scroll-target="#agregar-una-columna-personalizada">ğŸ“Œ Agregar una Columna Personalizada</a></li>
  <li><a href="#aplicar-reemplazos-de-forma-acumulativa" id="toc-aplicar-reemplazos-de-forma-acumulativa" class="nav-link" data-scroll-target="#aplicar-reemplazos-de-forma-acumulativa">ğŸ“Œ Aplicar Reemplazos de Forma Acumulativa</a>
  <ul class="collapse">
  <li><a href="#definiciÃ³n-de-la-lista-de-reemplazos" id="toc-definiciÃ³n-de-la-lista-de-reemplazos" class="nav-link" data-scroll-target="#definiciÃ³n-de-la-lista-de-reemplazos">DefiniciÃ³n de la Lista de Reemplazos</a></li>
  <li><a href="#aplicaciÃ³n-de-los-reemplazos-con-list.accumulate" id="toc-aplicaciÃ³n-de-los-reemplazos-con-list.accumulate" class="nav-link" data-scroll-target="#aplicaciÃ³n-de-los-reemplazos-con-list.accumulate">AplicaciÃ³n de los Reemplazos con List.Accumulate</a></li>
  </ul></li>
  <li><a href="#construcciÃ³n-de-mÃ©tricas-el-mapa-interactivo-filtro-y-grÃ¡ficos" id="toc-construcciÃ³n-de-mÃ©tricas-el-mapa-interactivo-filtro-y-grÃ¡ficos" class="nav-link" data-scroll-target="#construcciÃ³n-de-mÃ©tricas-el-mapa-interactivo-filtro-y-grÃ¡ficos">ConstrucciÃ³n de mÃ©tricas, el mapa interactivo, filtro y grÃ¡ficos</a>
  <ul class="collapse">
  <li><a href="#Ãºltima-actualizaciÃ³n" id="toc-Ãºltima-actualizaciÃ³n" class="nav-link" data-scroll-target="#Ãºltima-actualizaciÃ³n">Ãšltima ActualizaciÃ³n</a></li>
  <li><a href="#total-de-hogares-sin-luz" id="toc-total-de-hogares-sin-luz" class="nav-link" data-scroll-target="#total-de-hogares-sin-luz">Total de Hogares sin Luz</a></li>
  <li><a href="#comparaciÃ³n-Ãºltima-mediciÃ³n" id="toc-comparaciÃ³n-Ãºltima-mediciÃ³n" class="nav-link" data-scroll-target="#comparaciÃ³n-Ãºltima-mediciÃ³n">ComparaciÃ³n Ãºltima mediciÃ³n</a></li>
  <li><a href="#porcentaje-hogares-sin-luz" id="toc-porcentaje-hogares-sin-luz" class="nav-link" data-scroll-target="#porcentaje-hogares-sin-luz">Porcentaje hogares sin luz</a></li>
  <li><a href="#mapa-interactivo" id="toc-mapa-interactivo" class="nav-link" data-scroll-target="#mapa-interactivo">Mapa Interactivo</a></li>
  <li><a href="#top-3-comunas" id="toc-top-3-comunas" class="nav-link" data-scroll-target="#top-3-comunas">Top 3 Comunas</a></li>
  <li><a href="#hogares-sin-luz-por-regiÃ³n" id="toc-hogares-sin-luz-por-regiÃ³n" class="nav-link" data-scroll-target="#hogares-sin-luz-por-regiÃ³n">Hogares sin Luz por RegiÃ³n</a></li>
  <li><a href="#hogares-sin-luz-por-regiÃ³n-1" id="toc-hogares-sin-luz-por-regiÃ³n-1" class="nav-link" data-scroll-target="#hogares-sin-luz-por-regiÃ³n-1">Hogares sin luz por RegiÃ³n</a></li>
  <li><a href="#filtro-por-regiÃ³n" id="toc-filtro-por-regiÃ³n" class="nav-link" data-scroll-target="#filtro-por-regiÃ³n">Filtro por RegiÃ³n</a></li>
  <li><a href="#listo" id="toc-listo" class="nav-link" data-scroll-target="#listo">Listo!</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusiones" id="toc-conclusiones" class="nav-link" data-scroll-target="#conclusiones">Conclusiones</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">âš¡ AnÃ¡lisis en Tiempo Real del Suministro ElÃ©ctrico de Chile âš¡</h1>
</div>

<div>
  <div class="description">
    Un tutorial de cÃ³mo extraer datos con <strong>Playwright</strong>, procesarlos con <strong>Pandas</strong> y visualizar en <strong>PowerBI</strong>.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Simon Gomez </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introducciÃ³n" class="level2">
<h2 class="anchored" data-anchor-id="introducciÃ³n">IntroducciÃ³n</h2>
<p>Hace poco descubrÃ­ la pÃ¡gina de la Superintendecia de Electricidad y Combustibles (SEC). Me llamÃ³ la atenciÃ³n en particular su secciÃ³n de mÃ©tricas e informaciÃ³n de los cortes de luz a nivel nacional, debido a que notÃ© que hay un gran margen de mejora en su accesibilidad y visualizaciÃ³n de los datos para el usuario.</p>
</section>
<section id="quÃ©-haremos" class="level2">
<h2 class="anchored" data-anchor-id="quÃ©-haremos">Â¿QuÃ© haremos?</h2>
<ol type="1">
<li><p><strong>Preparar nuestro entorno</strong>: primero, instalaremos las dependencias necesarias para el proyecto.</p></li>
<li><p><strong>ExtracciÃ³n de los datos</strong>: aprenderemos a realizar web scraping con Playwright.</p></li>
<li><p><strong>TransformaciÃ³n de los datos</strong>: necesitaremos limpiar y procesar los datos extraÃ­dos con Pandas.</p></li>
<li><p><strong>VisualizaciÃ³n de los datos</strong>: finalmente, visualizaremos los datos en Powerbi.</p></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src=".\images/flow.png" class="img-fluid figure-img"></p>
<figcaption>Flujo de Trabajo TeÃ³rico</figcaption>
</figure>
</div>
<p>Como seÃ±ala el flujo, empezamos por la Api de la SEC a travÃ©s de python, luego pasamos a powerbi para terminar las trasnformaciÃ³n y la posterior visualizaciÃ³n</p>
</section>
<section id="aclaraciÃ³n" class="level2">
<h2 class="anchored" data-anchor-id="aclaraciÃ³n">AclaraciÃ³n ğŸ”´</h2>
<p>Si bien creamos una base histÃ³rica, esta es parte de otro proyecto independiente, donde tendremos un enfoque diferente con visualizaciones propias. Mantuve el flujo original ya que igualmente lo utilizaremos para una medida, ademÃ¡s que nos irÃ¡ acumulando los datos desde el momento que empezamos la iteraciÃ³n. De todas maneras, si deseas no utilizar esta base, basta con eliminar la parte del cÃ³digo donde la creamos.</p>
</section>
<section id="entorno-de-desarrollo" class="level2">
<h2 class="anchored" data-anchor-id="entorno-de-desarrollo">Entorno de Desarrollo</h2>
<p>Para este proyecto, necesitaremos instalar las siguientes dependencias: Playwright, Pandas y Powerbi.</p>
<p>Les recomiendo crear un entorno virtual para instalar las dependencias. Para ello, decidan un directorio donde quieran crear el entorno virtual y ejecuten el siguiente comando en la terminal:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    python <span class="op">-</span>m venv <span class="st">"nombre-del-entorno"</span><span class="op">-</span>env</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Una vez creado el entorno virtual, actÃ­venlo con el siguiente comando:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> <span class="st">"nombre-del-entorno"</span>-env/bin/activate</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ahora, instalemos las dependencias necesarias:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">pip</span> install playwright pandas</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="extracciÃ³n-de-los-datos" class="level2">
<h2 class="anchored" data-anchor-id="extracciÃ³n-de-los-datos">ExtracciÃ³n de los Datos</h2>
<p>Primero, necesitamos importar las librerÃ­as necesarias:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="instalar-dependencias" class="level1">
<h1>ğŸš€ Instalar Dependencias</h1>
<p>Con el entorno virtual activado, instalemos las librerÃ­as necesarias:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">pip</span> install playwright pandas</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>AdemÃ¡s, debemos instalar los navegadores de Playwright:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">playwright</span> install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<section id="extracciÃ³n-de-datos-con-playwright" class="level2">
<h2 class="anchored" data-anchor-id="extracciÃ³n-de-datos-con-playwright">ğŸ” ExtracciÃ³n de Datos con Playwright</h2>
<p>Usaremos <strong>Playwright</strong> para interceptar las respuestas de la API de la SEC.</p>
<section id="importaciÃ³n-de-librerÃ­as" class="level3">
<h3 class="anchored" data-anchor-id="importaciÃ³n-de-librerÃ­as">ğŸ“Œ ImportaciÃ³n de LibrerÃ­as</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="definiciÃ³n-de-archivos-de-salida" class="level2">
<h2 class="anchored" data-anchor-id="definiciÃ³n-de-archivos-de-salida">ğŸ“‚ DefiniciÃ³n de Archivos de Salida</h2>
<p>Guardaremos los datos en dos archivos CSV:</p>
<ul>
<li><strong><code>clientes_afectados_tiempo_real.csv</code></strong>: Contiene los datos mÃ¡s recientes.</li>
<li><strong><code>clientes_afectados_historico.csv</code></strong>: Mantiene un registro histÃ³rico.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>csv_tiempo_real <span class="op">=</span> <span class="st">"clientes_afectados_tiempo_real.csv"</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>csv_historico <span class="op">=</span> <span class="st">"clientes_afectados_historico.csv"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="anÃ¡lisis-de-la-funciÃ³n-intercept_responses" class="level1">
<h1>ğŸ” AnÃ¡lisis de la FunciÃ³n <code>intercept_responses()</code></h1>
<p>Esta funciÃ³n usa <strong>Playwright</strong> para interceptar las respuestas de la API de la <strong>Superintendencia de Electricidad y Combustibles de Chile (SEC)</strong> y extraer informaciÃ³n sobre cortes de luz. Luego, almacena estos datos en archivos CSV.</p>
<hr>
<section id="estructura-general" class="level2">
<h2 class="anchored" data-anchor-id="estructura-general">ğŸ“Œ <strong>Estructura General</strong></h2>
<ol type="1">
<li><strong>Abrir un navegador en modo headless</strong> (sin interfaz grÃ¡fica).</li>
<li><strong>Interceptar las respuestas de la API</strong> en la pÃ¡gina de la SEC.</li>
<li><strong>Extraer informaciÃ³n clave</strong> de los datos JSON recibidos.</li>
<li><strong>Procesar los datos</strong> para calcular tiempos y crear identificadores Ãºnicos.</li>
<li><strong>Guardar la informaciÃ³n en archivos CSV</strong>.</li>
<li><strong>Cerrar el navegador</strong> una vez completado el proceso.</li>
</ol>
<hr>
</section>
<section id="paso-a-paso-de-la-funciÃ³n" class="level2">
<h2 class="anchored" data-anchor-id="paso-a-paso-de-la-funciÃ³n">ğŸ›  <strong>Paso a Paso de la FunciÃ³n</strong></h2>
<section id="inicializar-playwright-y-abrir-el-navegador" class="level3">
<h3 class="anchored" data-anchor-id="inicializar-playwright-y-abrir-el-navegador">1ï¸âƒ£ <strong>Inicializar Playwright y Abrir el Navegador</strong></h3>
<p>Se utiliza <code>sync_playwright()</code> para iniciar Playwright y lanzar un navegador <strong>Chromium</strong> en modo <strong>headless</strong> (sin interfaz grÃ¡fica).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span><span class="va">True</span>)  <span class="co"># Lanzar navegador en modo headless</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    page <span class="op">=</span> browser.new_page()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li>Crea una instancia de Playwright.</li>
<li>Lanza un navegador Chromium sin interfaz visual.</li>
<li>Crea una nueva pÃ¡gina en ese navegador.</li>
</ul>
<hr>
</section>
<section id="definir-una-lista-para-almacenar-registros" class="level3">
<h3 class="anchored" data-anchor-id="definir-una-lista-para-almacenar-registros">2ï¸âƒ£ <strong>Definir una Lista para Almacenar Registros</strong></h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>registros <span class="op">=</span> []  <span class="co"># Lista para almacenar datos nuevos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿Para quÃ© sirve?</strong></p>
<ul>
<li>AquÃ­ se guardarÃ¡n los datos extraÃ­dos de la API antes de escribirlos en los archivos CSV.</li>
</ul>
<hr>
</section>
<section id="interceptar-las-respuestas-de-la-api" class="level3">
<h3 class="anchored" data-anchor-id="interceptar-las-respuestas-de-la-api">3ï¸âƒ£ <strong>Interceptar las Respuestas de la API</strong></h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> handle_response(response):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"GetPorFecha"</span> <span class="kw">in</span> response.url:</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> response.json()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>            timestamp_actual <span class="op">=</span> datetime.now()  <span class="co"># Tiempo de consulta</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>Verifica si la URL de la respuesta contiene <code>"GetPorFecha"</code></strong>, lo que indica que es una respuesta de la API relevante.</li>
<li><strong>Convierte la respuesta en JSON</strong> (<code>response.json()</code>).</li>
<li><strong>Guarda el timestamp actual</strong> para identificar cuÃ¡ndo se hizo la consulta.</li>
</ul>
<hr>
</section>
<section id="procesar-los-datos-extraÃ­dos" class="level3">
<h3 class="anchored" data-anchor-id="procesar-los-datos-extraÃ­dos">4ï¸âƒ£ <strong>Procesar los Datos ExtraÃ­dos</strong></h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> data:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    actualizado_hace <span class="op">=</span> entry.get(<span class="st">"ACTUALIZADO_HACE"</span>, <span class="st">""</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    minutos_atras <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> re.search(<span class="vs">r'(\d+)\s+Minutos'</span>, actualizado_hace)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> match:</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        minutos_atras <span class="op">=</span> <span class="bu">int</span>(match.group(<span class="dv">1</span>))  <span class="co"># Extrae el nÃºmero antes de "Minutos"</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    hora_exacta_reporte <span class="op">=</span> timestamp_actual <span class="op">-</span> timedelta(minutes<span class="op">=</span>minutos_atras)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>Extrae el campo <code>"ACTUALIZADO_HACE"</code></strong>, que indica hace cuÃ¡nto tiempo se actualizÃ³ la informaciÃ³n.</li>
<li><strong>Usa una expresiÃ³n regular (<code>re.search</code>) para extraer los minutos</strong> mencionados en <code>"ACTUALIZADO_HACE"</code>.</li>
<li><strong>Calcula la hora exacta del reporte</strong>, restando esos minutos del timestamp actual.</li>
</ul>
<hr>
</section>
<section id="crear-un-identificador-Ãºnico-para-cada-registro" class="level3">
<h3 class="anchored" data-anchor-id="crear-un-identificador-Ãºnico-para-cada-registro">5ï¸âƒ£ <strong>Crear un Identificador Ãšnico para Cada Registro</strong></h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>unique_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>entry<span class="sc">.</span>get(<span class="st">'FECHA_INT_STR'</span>, <span class="st">''</span>)<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>entry<span class="sc">.</span>get(<span class="st">'REGION'</span>, <span class="st">''</span>)<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>entry<span class="sc">.</span>get(<span class="st">'COMUNA'</span>, <span class="st">''</span>)<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>entry<span class="sc">.</span>get(<span class="st">'EMPRESA'</span>, <span class="st">''</span>)<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>entry<span class="sc">.</span>get(<span class="st">'CLIENTES_AFECTADOS'</span>, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>hora_exacta_reporte<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿Por quÃ© es importante esto?</strong></p>
<ul>
<li><strong>Evita la duplicaciÃ³n de datos</strong>, asegurando que cada registro tenga un ID Ãºnico.</li>
<li><strong>Facilita la organizaciÃ³n</strong> en los archivos CSV.</li>
</ul>
<hr>
</section>
<section id="guardar-los-datos-en-la-lista-registros" class="level3">
<h3 class="anchored" data-anchor-id="guardar-los-datos-en-la-lista-registros">6ï¸âƒ£ <strong>Guardar los Datos en la Lista <code>registros</code></strong></h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>registros.append({</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ID_UNICO"</span>: unique_id,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TIMESTAMP"</span>: timestamp_actual.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HORA_EXACTA_REPORTE"</span>: hora_exacta_reporte.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FECHA"</span>: entry.get(<span class="st">"FECHA_INT_STR"</span>, <span class="st">""</span>),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"REGION"</span>: entry.get(<span class="st">"NOMBRE_REGION"</span>, <span class="st">""</span>),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"COMUNA"</span>: entry.get(<span class="st">"NOMBRE_COMUNA"</span>, <span class="st">""</span>),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EMPRESA"</span>: entry.get(<span class="st">"NOMBRE_EMPRESA"</span>, <span class="st">""</span>),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CLIENTES_AFECTADOS"</span>: entry.get(<span class="st">"CLIENTES_AFECTADOS"</span>, <span class="dv">0</span>),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ACTUALIZADO_HACE"</span>: actualizado_hace</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>Guarda cada registro como un diccionario</strong> dentro de la lista <code>registros</code>.</li>
<li><strong>Almacena los datos clave</strong> como fecha, regiÃ³n, comuna, empresa y clientes afectados.</li>
</ul>
<hr>
</section>
<section id="capturar-las-respuestas-de-la-api" class="level3">
<h3 class="anchored" data-anchor-id="capturar-las-respuestas-de-la-api">7ï¸âƒ£ <strong>Capturar las Respuestas de la API</strong></h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>page.on(<span class="st">"response"</span>, handle_response)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>Asocia la funciÃ³n <code>handle_response</code> con cada respuesta de la pÃ¡gina</strong>.</li>
<li><strong>Intercepta las respuestas en segundo plano</strong> mientras se carga la web.</li>
</ul>
<hr>
</section>
<section id="acceder-a-la-pÃ¡gina-de-la-sec" class="level3">
<h3 class="anchored" data-anchor-id="acceder-a-la-pÃ¡gina-de-la-sec">8ï¸âƒ£ <strong>Acceder a la PÃ¡gina de la SEC</strong></h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>page.goto(<span class="st">"https://apps.sec.cl/INTONLINEv1/index.aspx"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>page.wait_for_timeout(<span class="dv">5000</span>)  <span class="co"># Espera para capturar datos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>Abre la pÃ¡gina de la SEC en el navegador</strong>.</li>
<li><strong>Espera 5 segundos</strong> para permitir la carga de datos.</li>
</ul>
<hr>
</section>
<section id="cerrar-el-navegador" class="level3">
<h3 class="anchored" data-anchor-id="cerrar-el-navegador">9ï¸âƒ£ <strong>Cerrar el Navegador</strong></h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>browser.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿Por quÃ© es importante?</strong></p>
<ul>
<li><strong>Libera recursos del sistema</strong>.</li>
<li><strong>Evita que el script consuma demasiada memoria</strong>.</li>
</ul>
<hr>
</section>
</section>
<section id="guardado-de-datos-en-csv" class="level2">
<h2 class="anchored" data-anchor-id="guardado-de-datos-en-csv">ğŸ“Š <strong>Guardado de Datos en CSV</strong></h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> registros:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    df_new <span class="op">=</span> pd.DataFrame(registros)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ğŸ“Œ Guardar en CSV histÃ³rico</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(csv_historico):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        df_historico <span class="op">=</span> pd.read_csv(csv_historico, encoding<span class="op">=</span><span class="st">"utf-8-sig"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        df_historico <span class="op">=</span> pd.concat([df_historico, df_new]).drop_duplicates(subset<span class="op">=</span>[<span class="st">"ID_UNICO"</span>], keep<span class="op">=</span><span class="st">"first"</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        df_historico <span class="op">=</span> df_new</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    df_historico.to_csv(csv_historico, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">"utf-8-sig"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ğŸ“Œ Guardar en CSV de Tiempo Real</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    df_new.to_csv(csv_tiempo_real, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">"utf-8-sig"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"âœ… Datos guardados en:</span><span class="ch">\n</span><span class="ss">ğŸ“Œ </span><span class="sc">{</span>csv_historico<span class="sc">}</span><span class="ss"> (HistÃ³rico)</span><span class="ch">\n</span><span class="ss">ğŸ“Œ </span><span class="sc">{</span>csv_tiempo_real<span class="sc">}</span><span class="ss"> (Tiempo Real)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>Convierte los registros en un DataFrame de Pandas</strong>.</li>
<li><strong>Guarda los datos en CSV histÃ³rico y de tiempo real</strong>.</li>
<li><strong>Evita duplicados basÃ¡ndose en el ID Ãºnico</strong>.</li>
</ul>
<hr>
</section>
<section id="automatizaciÃ³n-cada-5-minutos" class="level2">
<h2 class="anchored" data-anchor-id="automatizaciÃ³n-cada-5-minutos">ğŸ” <strong>AutomatizaciÃ³n Cada 5 Minutos</strong></h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    intercept_responses()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"â³ Esperando 5 minutos para la siguiente ejecuciÃ³n...</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span>)  <span class="co"># 5 minutos en segundos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ“Œ <strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>Ejecuta <code>intercept_responses()</code> en un bucle infinito</strong>.</li>
<li><strong>Espera 5 minutos (<code>time.sleep(5 * 60)</code>) antes de volver a ejecutar la funciÃ³n</strong>.</li>
</ul>
<p>Puedes elegir el tiempo que desees, yo decidÃ­ 5 minutos.</p>
</section>
<section id="extra" class="level2">
<h2 class="anchored" data-anchor-id="extra">Extra</h2>
<p>Esta es una manera de automatizar, no obstante, tambiÃ©n puedes utilizar el programador de tareas en Windows y ejecutar un .bat que contenga la ejecuciÃ³n del .py. Si lo ejecutas, no es necesario mantener el cÃ³digo de loop de arriba, ya que el programador lo puedes configurar con intervalos de tiempo.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">@echo</span> off</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> C:<span class="dt">\U</span>sers<span class="dt">\S</span>IMON<span class="dt">\D</span>esktop<span class="dt">\K</span>aggle<span class="dt">\l</span>uz</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> end.py</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="felicidades" class="level3">
<h3 class="anchored" data-anchor-id="felicidades">Felicidadesâ­!</h3>
<p>Ya tenemos nuestra base de datos casi lista para su visualizaciÃ³n. Si bien podrÃ­amos terminar de darle formato a los datos directamente con pandas, es una perfecta ocasiÃ³n para hacerlo en powerbi, ya que podremos visualizar con facilidad los cambios que iremos realizando para construir nuestro dashboard interactivo.</p>
</section>
<section id="aclaraciÃ³n-1" class="level3">
<h3 class="anchored" data-anchor-id="aclaraciÃ³n-1">AclaraciÃ³n ğŸ”´</h3>
<p>Este no es un tutorial de cÃ³mo utilizar PowerBI, por lo que es necesario saber lo bÃ¡sico para poder seguir el tutorial: instalaciÃ³n, configuraciÃ³n, comandos, etc.</p>
</section>
</section>
</section>
<section id="powerbi-transformaciÃ³n-y-visualizaciÃ³n-de-los-datos" class="level1">
<h1>Powerbi: transformaciÃ³n y VisualizaciÃ³n de los datos</h1>
<p>Dependiendo de la carpeta donde hayamos realizado nuestro proyecto, podremos encontrar el archivo resultante, el cual utilizaremos ahora.</p>
<p>Para poder manipular nuestros datos en Powerbi hay que seguir estos sencillos pasos:</p>
<ul>
<li><p><strong>Abrir PowerBI</strong></p></li>
<li><p><strong>Click en Get data from other sources</strong></p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/get_data.png" class="img-fluid figure-img"></p>
<figcaption>Figura 1</figcaption>
</figure>
</div>
<ul>
<li><strong>Seleccionamos Text/CSV</strong></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/select_csv.png" class="img-fluid figure-img"></p>
<figcaption>Figura 3</figcaption>
</figure>
</div>
<ul>
<li><strong>Buscamos nuestro archivo .csv</strong></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Text_csv.png" class="img-fluid figure-img"></p>
<figcaption>Figura 3</figcaption>
</figure>
</div>
<ul>
<li><strong>Click en Load</strong></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/load_data.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
<p>A continuaciÃ³n explicarÃ© paso a paso el cÃ³digo M que utilizamos para transformar datos en Power Query. Este script carga nuestro archivo CSV, promociona los encabezados, cambia los tipos de datos, agrega una columna personalizada concatenando un texto fijo con el valor existente en la columna <strong>REGION</strong>, y aplica una serie de reemplazos para corregir los nombres de las regiones de forma automatizada.</p>
<ul>
<li><strong>En la secciÃ³n Home click en Advanced Editor</strong></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Advance_editor.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
<ul>
<li><p><strong>Copia y pega el cÃ³digo de mÃ¡s abajo</strong></p></li>
<li><p><strong>Click en Done</strong></p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Code_M.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
</section>
<section id="cÃ³digo-m" class="level1">
<h1>CÃ³digo M</h1>
<div class="sourceCode" id="cb21"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="va">let</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">//</span> <span class="va">Cargar</span> <span class="va">archivo</span> <span class="va">CSV</span> <span class="va">y</span> <span class="va">promover</span> <span class="va">encabezados</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">Source</span> <span class="op">=</span> <span class="va">Csv</span>.<span class="va">Document</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">File</span>.<span class="va">Contents</span>(<span class="st">"C:\Users\SIMON\Desktop\Kaggle\luz\power_bi\clientes_afectados_tiempo_real.csv"</span>)<span class="op">,</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        [<span class="va">Delimiter</span><span class="op">=</span><span class="st">","</span><span class="op">,</span> <span class="va">Columns</span><span class="op">=</span><span class="fl">9</span><span class="op">,</span> <span class="va">Encoding</span><span class="op">=</span><span class="fl">65001</span><span class="op">,</span> <span class="va">QuoteStyle</span><span class="op">=</span><span class="va">QuoteStyle</span>.<span class="va">None</span>]</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    #<span class="st">"Promoted Headers"</span> <span class="op">=</span> <span class="va">Table</span>.<span class="va">PromoteHeaders</span>(<span class="va">Source</span><span class="op">,</span> [<span class="va">PromoteAllScalars</span><span class="op">=</span><span class="va">true</span>])<span class="op">,</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">//</span> <span class="va">Cambiar</span> <span class="va">tipos</span> <span class="va">de</span> <span class="va">datos</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    #<span class="st">"Changed Type"</span> <span class="op">=</span> <span class="va">Table</span>.<span class="va">TransformColumnTypes</span>(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        #<span class="st">"Promoted Headers"</span><span class="op">,</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"ID_UNICO"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}<span class="op">,</span> </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"TIMESTAMP"</span><span class="op">,</span> <span class="va">type</span> <span class="va">datetime</span>}<span class="op">,</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"HORA_EXACTA_REPORTE"</span><span class="op">,</span> <span class="va">type</span> <span class="va">datetime</span>}<span class="op">,</span> </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"FECHA"</span><span class="op">,</span> <span class="va">type</span> <span class="va">date</span>}<span class="op">,</span> </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"REGION"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}<span class="op">,</span> </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"COMUNA"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}<span class="op">,</span> </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"EMPRESA"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}<span class="op">,</span> </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"CLIENTES_AFECTADOS"</span><span class="op">,</span> <span class="va">Int64</span>.<span class="va">Type</span>}<span class="op">,</span> </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"ACTUALIZADO_HACE"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">//</span> <span class="va">Agregar</span> <span class="va">columna</span> <span class="va">REGION_CORREGIDA</span> <span class="va">concatenando</span> <span class="st">"RegiÃ³n de "</span> <span class="va">con</span> <span class="va">el</span> <span class="va">valor</span> <span class="va">de</span> <span class="va">REGION</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    #<span class="st">"Added Custom"</span> <span class="op">=</span> <span class="va">Table</span>.<span class="va">AddColumn</span>(</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        #<span class="st">"Changed Type"</span><span class="op">,</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"REGION_CORREGIDA"</span><span class="op">,</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">each</span> <span class="st">"RegiÃ³n de "</span> <span class="op">&amp;</span> [<span class="va">REGION</span>]</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">//</span> <span class="va">Lista</span> <span class="va">de</span> <span class="va">reemplazos</span> <span class="va">para</span> <span class="va">la</span> <span class="va">columna</span> <span class="va">REGION_CORREGIDA</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    <span class="va">Reemplazos</span> <span class="op">=</span> {</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de Metropolitana"</span><span class="op">,</span> <span class="st">"RegiÃ³n Metropolitana de Santiago"</span>}<span class="op">,</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de Tarapaca"</span><span class="op">,</span> <span class="st">"RegiÃ³n de TarapacÃ¡"</span>}<span class="op">,</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de Magallanes"</span><span class="op">,</span> <span class="st">"RegiÃ³n de Magallanes y AntÃ¡rtica Chilena"</span>}<span class="op">,</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de AysÃ©n"</span><span class="op">,</span> <span class="st">"RegiÃ³n de AysÃ©n del Gral.IbaÃ±ez del Campo"</span>}<span class="op">,</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de O`Higgins"</span><span class="op">,</span> <span class="st">"RegiÃ³n del Libertador Bernardo O'Higgins"</span>}<span class="op">,</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de Biobio"</span><span class="op">,</span> <span class="st">"RegiÃ³n del BÃ­o-BÃ­o"</span>}<span class="op">,</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de La Araucania"</span><span class="op">,</span> <span class="st">"RegiÃ³n de La AraucanÃ­a"</span>}<span class="op">,</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de Los Rios"</span><span class="op">,</span> <span class="st">"RegiÃ³n de los RÃ­os"</span>}<span class="op">,</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de Valparaiso"</span><span class="op">,</span> <span class="st">"RegiÃ³n de ValparaÃ­so"</span>}<span class="op">,</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"RegiÃ³n de Maule"</span><span class="op">,</span> <span class="st">"RegiÃ³n del Maule"</span>}</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">//</span> <span class="va">Aplicar</span> <span class="va">reemplazos</span> <span class="va">a</span> <span class="va">REGION_CORREGIDA</span> <span class="va">de</span> <span class="va">forma</span> <span class="va">acumulativa</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    <span class="va">Resultado</span> <span class="op">=</span> <span class="va">List</span>.<span class="va">Accumulate</span>(</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>        <span class="va">Reemplazos</span><span class="op">,</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>        #<span class="st">"Added Custom"</span><span class="op">,</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>        (<span class="va">tabla</span><span class="op">,</span> <span class="va">par</span>) <span class="op">=&gt;</span> <span class="va">Table</span>.<span class="va">ReplaceValue</span>(</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>            <span class="va">tabla</span><span class="op">,</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>            <span class="va">par</span>{<span class="fl">0</span>}<span class="op">,</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>            <span class="va">par</span>{<span class="fl">1</span>}<span class="op">,</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>            <span class="va">Replacer</span>.<span class="va">ReplaceText</span><span class="op">,</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"REGION_CORREGIDA"</span>}</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a><span class="va">in</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    <span class="va">Resultado</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="explicaciÃ³n-del-cÃ³digo-m" class="level2">
<h2 class="anchored" data-anchor-id="explicaciÃ³n-del-cÃ³digo-m">ExplicaciÃ³n del cÃ³digo M</h2>
<p>A continuaciÃ³n, desglosamos cada parte del cÃ³digo para comprender su funcionamiento.</p>
<hr>
</section>
<section id="cargar-el-archivo-csv-y-promover-encabezados" class="level2">
<h2 class="anchored" data-anchor-id="cargar-el-archivo-csv-y-promover-encabezados">ğŸ“Œ Cargar el Archivo CSV y Promover Encabezados</h2>
<div class="sourceCode" id="cb22"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="va">Source</span> <span class="op">=</span> <span class="va">Csv</span>.<span class="va">Document</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">File</span>.<span class="va">Contents</span>(<span class="st">"C:\Users\SIMON\Desktop\Kaggle\luz\power_bi\clientes_afectados_tiempo_real.csv"</span>)<span class="op">,</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    [<span class="va">Delimiter</span><span class="op">=</span><span class="st">","</span><span class="op">,</span> <span class="va">Columns</span><span class="op">=</span><span class="fl">9</span><span class="op">,</span> <span class="va">Encoding</span><span class="op">=</span><span class="fl">65001</span><span class="op">,</span> <span class="va">QuoteStyle</span><span class="op">=</span><span class="va">QuoteStyle</span>.<span class="va">None</span>]</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">,</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>#<span class="st">"Promoted Headers"</span> <span class="op">=</span> <span class="va">Table</span>.<span class="va">PromoteHeaders</span>(<span class="va">Source</span><span class="op">,</span> [<span class="va">PromoteAllScalars</span><span class="op">=</span><span class="va">true</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>Csv.Document &amp; File.Contents:</strong> Carga el archivo CSV desde la ruta especificada.</li>
<li><strong>Table.PromoteHeaders:</strong> Convierte la primera fila en los nombres de columna, facilitando la manipulaciÃ³n posterior.</li>
</ul>
<hr>
</section>
<section id="cambiar-tipos-de-datos" class="level2">
<h2 class="anchored" data-anchor-id="cambiar-tipos-de-datos">ğŸ“Œ Cambiar Tipos de Datos</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>#<span class="st">"Changed Type"</span> <span class="op">=</span> <span class="va">Table</span>.<span class="va">TransformColumnTypes</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    #<span class="st">"Promoted Headers"</span><span class="op">,</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"ID_UNICO"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}<span class="op">,</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"TIMESTAMP"</span><span class="op">,</span> <span class="va">type</span> <span class="va">datetime</span>}<span class="op">,</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"HORA_EXACTA_REPORTE"</span><span class="op">,</span> <span class="va">type</span> <span class="va">datetime</span>}<span class="op">,</span> </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"FECHA"</span><span class="op">,</span> <span class="va">type</span> <span class="va">date</span>}<span class="op">,</span> </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"REGION"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}<span class="op">,</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"COMUNA"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}<span class="op">,</span> </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"EMPRESA"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}<span class="op">,</span> </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"CLIENTES_AFECTADOS"</span><span class="op">,</span> <span class="va">Int64</span>.<span class="va">Type</span>}<span class="op">,</span> </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"ACTUALIZADO_HACE"</span><span class="op">,</span> <span class="va">type</span> <span class="va">text</span>}</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li>Se establecen los tipos de datos adecuados para cada columna, lo que es crucial para evitar errores y asegurar que los cÃ¡lculos o transformaciones posteriores se realicen correctamente.</li>
</ul>
<hr>
</section>
<section id="agregar-una-columna-personalizada" class="level2">
<h2 class="anchored" data-anchor-id="agregar-una-columna-personalizada">ğŸ“Œ Agregar una Columna Personalizada</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>#<span class="st">"Added Custom"</span> <span class="op">=</span> <span class="va">Table</span>.<span class="va">AddColumn</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    #<span class="st">"Changed Type"</span><span class="op">,</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"REGION_CORREGIDA"</span><span class="op">,</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">each</span> <span class="st">"RegiÃ³n de "</span> <span class="op">&amp;</span> [<span class="va">REGION</span>]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>Table.AddColumn:</strong> Agrega una nueva columna a la tabla.</li>
<li><strong>â€œREGION_CORREGIDAâ€:</strong> Es el nombre de la nueva columna.</li>
<li><strong>each â€œRegiÃ³n deâ€ &amp; [REGION]:</strong> Para cada fila, concatena el texto fijo <code>"RegiÃ³n de "</code> con el valor existente en la columna <strong>REGION</strong>.</li>
</ul>
<p><em>Ejemplo:</em><br>
Si el valor en <strong>REGION</strong> es <code>"Metropolitana"</code>, el resultado en <strong>REGION_CORREGIDA</strong> serÃ¡ <code>"RegiÃ³n de Metropolitana"</code>.</p>
<hr>
</section>
<section id="aplicar-reemplazos-de-forma-acumulativa" class="level2">
<h2 class="anchored" data-anchor-id="aplicar-reemplazos-de-forma-acumulativa">ğŸ“Œ Aplicar Reemplazos de Forma Acumulativa</h2>
<section id="definiciÃ³n-de-la-lista-de-reemplazos" class="level3">
<h3 class="anchored" data-anchor-id="definiciÃ³n-de-la-lista-de-reemplazos">DefiniciÃ³n de la Lista de Reemplazos</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="va">Reemplazos</span> <span class="op">=</span> {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de Metropolitana"</span><span class="op">,</span> <span class="st">"RegiÃ³n Metropolitana de Santiago"</span>}<span class="op">,</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de Tarapaca"</span><span class="op">,</span> <span class="st">"RegiÃ³n de TarapacÃ¡"</span>}<span class="op">,</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de Magallanes"</span><span class="op">,</span> <span class="st">"RegiÃ³n de Magallanes y AntÃ¡rtica Chilena"</span>}<span class="op">,</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de AysÃ©n"</span><span class="op">,</span> <span class="st">"RegiÃ³n de AysÃ©n del Gral.IbaÃ±ez del Campo"</span>}<span class="op">,</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de O`Higgins"</span><span class="op">,</span> <span class="st">"RegiÃ³n del Libertador Bernardo O'Higgins"</span>}<span class="op">,</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de Biobio"</span><span class="op">,</span> <span class="st">"RegiÃ³n del BÃ­o-BÃ­o"</span>}<span class="op">,</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de La Araucania"</span><span class="op">,</span> <span class="st">"RegiÃ³n de La AraucanÃ­a"</span>}<span class="op">,</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de Los Rios"</span><span class="op">,</span> <span class="st">"RegiÃ³n de los RÃ­os"</span>}<span class="op">,</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de Valparaiso"</span><span class="op">,</span> <span class="st">"RegiÃ³n de ValparaÃ­so"</span>}<span class="op">,</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"RegiÃ³n de Maule"</span><span class="op">,</span> <span class="st">"RegiÃ³n del Maule"</span>}</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li>Se define una lista de pares, donde cada par contiene:
<ul>
<li><strong>Texto original:</strong> Valor que aparece en la columna <strong>REGION_CORREGIDA</strong>.</li>
<li><strong>Texto corregido:</strong> Valor con el que se reemplazarÃ¡ el texto original.</li>
</ul></li>
</ul>
</section>
<section id="aplicaciÃ³n-de-los-reemplazos-con-list.accumulate" class="level3">
<h3 class="anchored" data-anchor-id="aplicaciÃ³n-de-los-reemplazos-con-list.accumulate">AplicaciÃ³n de los Reemplazos con List.Accumulate</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="va">Resultado</span> <span class="op">=</span> <span class="va">List</span>.<span class="va">Accumulate</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">Reemplazos</span><span class="op">,</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    #<span class="st">"Added Custom"</span><span class="op">,</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    (<span class="va">tabla</span><span class="op">,</span> <span class="va">par</span>) <span class="op">=&gt;</span> <span class="va">Table</span>.<span class="va">ReplaceValue</span>(</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">tabla</span><span class="op">,</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">par</span>{<span class="fl">0</span>}<span class="op">,</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">par</span>{<span class="fl">1</span>}<span class="op">,</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">Replacer</span>.<span class="va">ReplaceText</span><span class="op">,</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"REGION_CORREGIDA"</span>}</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Â¿QuÃ© hace esto?</strong></p>
<ul>
<li><strong>List.Accumulate:</strong> Itera sobre cada par de la lista <strong>Reemplazos</strong>.</li>
<li><strong>#â€œAdded Customâ€:</strong> Es el paso inicial que contiene la tabla con la nueva columna <strong>REGION_CORREGIDA</strong>.</li>
<li><strong>Table.ReplaceValue:</strong> En cada iteraciÃ³n, reemplaza el valor <strong>par{0}</strong> (texto original) por <strong>par{1}</strong> (texto corregido) en la columna <strong>REGION_CORREGIDA</strong>.</li>
<li>El proceso es acumulativo: cada reemplazo se aplica sobre el resultado del reemplazo anterior.</li>
</ul>
<hr>
</section>
</section>
<section id="construcciÃ³n-de-mÃ©tricas-el-mapa-interactivo-filtro-y-grÃ¡ficos" class="level2">
<h2 class="anchored" data-anchor-id="construcciÃ³n-de-mÃ©tricas-el-mapa-interactivo-filtro-y-grÃ¡ficos">ConstrucciÃ³n de mÃ©tricas, el mapa interactivo, filtro y grÃ¡ficos</h2>
<p>En PowerBi utilizamos una herramienta llamada medida, con esta podemos realizar cÃ¡lculos utilizando la sintaxis adecuada, lo que permite construir mÃ©tricas a partir de nuestros datos</p>
<section id="Ãºltima-actualizaciÃ³n" class="level3">
<h3 class="anchored" data-anchor-id="Ãºltima-actualizaciÃ³n">Ãšltima ActualizaciÃ³n</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>Ãš<span class="va">ltima</span> <span class="va">ActualizaciÃ³n</span> <span class="op">=</span> <span class="va">MAX</span>(<span class="ss">'clientes_afectados_historico'</span>[<span class="va">TIMESTAMP</span>])   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Con esta medida podremos construir una <em>card</em> con la hora actual que corresponde la informaciÃ³n. Esta por defecto incluye fechas, vamos a corregirlo:</p>
<ul>
<li><strong>Click en <em>Format Visual</em> en el menÃº de la derecha</strong></li>
<li><strong>General</strong></li>
<li><strong><em>Data Format</em></strong></li>
<li><strong>en <em>Format option</em> buscaremos el formato <em>long Time</em></strong></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/format_visual.png" class="img-fluid figure-img"></p>
<figcaption>Figura x</figcaption>
</figure>
</div>
</section>
<section id="total-de-hogares-sin-luz" class="level3">
<h3 class="anchored" data-anchor-id="total-de-hogares-sin-luz">Total de Hogares sin Luz</h3>
<p>Es una buena prÃ¡ctica crear las medidas explÃ­citamente, es decir, introducir el cÃ³digo de lo que queremos que haga nuestra medida. Para efectos prÃ¡cticos, utilizaremos la medida implÃ­cita de sumatoria que nos ofrece PowerBi:</p>
<ul>
<li><strong>Seleccionamos una <em>card</em> y arrastramos CLIENTES_AFECTADOS a <em>field</em></strong></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Total_casas_kpi.png" class="img-fluid figure-img"></p>
<figcaption>Figura x</figcaption>
</figure>
</div>
</section>
<section id="comparaciÃ³n-Ãºltima-mediciÃ³n" class="level3">
<h3 class="anchored" data-anchor-id="comparaciÃ³n-Ãºltima-mediciÃ³n">ComparaciÃ³n Ãºltima mediciÃ³n</h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="va">ComparaciÃ³n</span> Ãº<span class="va">ltima</span> <span class="va">mediciÃ³n</span> <span class="op">=</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="va">VAR</span> <span class="va">ultimoTiempo</span> <span class="op">=</span> <span class="va">MAX</span>(<span class="va">clientes_afectados_tiempo_real</span>[<span class="va">TIMESTAMP</span>])</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="va">VAR</span> <span class="va">PenultimoTiempo</span> <span class="op">=</span> </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">CALCULATE</span>(<span class="va">MAX</span>(<span class="va">clientes_afectados_tiempo_real</span>[<span class="va">TIMESTAMP</span>])<span class="op">,</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>              <span class="va">clientes_afectados_tiempo_real</span>[<span class="va">TIMESTAMP</span>] <span class="op">&lt;</span> <span class="va">ultimoTiempo</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="va">VAR</span> <span class="va">Afectados_Ultima</span> <span class="op">=</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">CALCULATE</span>(<span class="va">SUM</span>(<span class="va">clientes_afectados_tiempo_real</span>[<span class="va">CLIENTES_AFECTADOS</span>])<span class="op">,</span> </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>              <span class="va">clientes_afectados_tiempo_real</span>[<span class="va">TIMESTAMP</span>] <span class="op">=</span> <span class="va">ultimoTiempo</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="va">VAR</span> <span class="va">Afectados_Anterior</span> <span class="op">=</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">CALCULATE</span>(<span class="va">SUM</span>(<span class="va">clientes_afectados_tiempo_real</span>[<span class="va">CLIENTES_AFECTADOS</span>])<span class="op">,</span> </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>              <span class="va">clientes_afectados_tiempo_real</span>[<span class="va">TIMESTAMP</span>] <span class="op">=</span> <span class="va">PenultimoTiempo</span>)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="va">RETURN</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">Afectados_Ultima</span> <span class="op">-</span> <span class="va">Afectados_Anterior</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>BÃ¡sicamente esta medida crea 4 variables:</p>
<ul>
<li><strong>ultimoTiempo -&gt; el tiempo mÃ¡s reciente</strong></li>
<li><strong>PenultimoTiempo -&gt; mediciÃ³n pasada</strong></li>
<li><strong>Afectados_Ultima -&gt; total de hogares afectados mÃ¡s reciente</strong></li>
<li><strong>Afectados_Anterior -&gt; total de hogares afectados de la mediciÃ³n anterior</strong></li>
</ul>
<p>A travÃ©s de estas podemos obtener la variaciÃ³n nominal de los hogares afectados respecto a la mediciÃ³n anterior</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Comparacion_ultima.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
</section>
<section id="porcentaje-hogares-sin-luz" class="level3">
<h3 class="anchored" data-anchor-id="porcentaje-hogares-sin-luz">Porcentaje hogares sin luz</h3>
<p>Con esta mÃ©trica podremos dimensionar la cantidad de hogares sin suministro elÃ©ctrico a nivel nacional. El total de hogares fue un dato que recogÃ­ del <a href="link">sitio web oficial</a></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="va">Porcentaje_Hogares_Sin_Luz</span> <span class="op">=</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="va">VAR</span> <span class="va">Total_Hogares</span> <span class="op">=</span> <span class="fl">6534588</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="va">VAR</span> <span class="va">Total_Afectados</span> <span class="op">=</span> <span class="va">SUM</span>(<span class="va">clientes_afectados_tiempo_real</span>[<span class="va">Clientes_Afectados</span>])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="va">RETURN</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">DIVIDE</span>(<span class="va">Total_Afectados</span><span class="op">,</span> <span class="va">Total_Hogares</span><span class="op">,</span> <span class="fl">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/proporcion_nacional.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
</section>
<section id="mapa-interactivo" class="level3">
<h3 class="anchored" data-anchor-id="mapa-interactivo">Mapa Interactivo</h3>
<p>Visitando mi <a href="link">repositorio</a> puedes descargar el archivo .topojson necesario para visualizar el mapa de Chile. Una vez descargado, necesitamos habilitar la opciÃ³n de mapas de forma (Shape Map) en nuestro Powerbi:</p>
<p>-<strong>En la esquina inferior izquierda de la secciÃ³n File click en Options and settings y luego Options</strong> -<strong>Click en Preview Features y activamos el shape map visual</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Shape.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
<p>Una vez activado lo introducimos con la interfaz grÃ¡fica seleccionando <strong>Shape map</strong> e introducimos como <strong>Location</strong> nuestra columna <strong>REGION_CORREGIDA</strong> que creamos antes y en <strong>Color saturation</strong> la sumatoria de los clientes afectados.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Mapa1.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
<p>Nos dirigimos a la pestaÃ±a <strong>visual</strong> del mapa y en <strong>map type</strong> seleccionamos <strong>Custom map</strong> y en <strong>Add a map type</strong> agregamos nuestro archivo json</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/mapa2.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
</section>
<section id="top-3-comunas" class="level3">
<h3 class="anchored" data-anchor-id="top-3-comunas">Top 3 Comunas</h3>
<p>Ya sabes cÃ³mo agregar una medida, por lo que te proporciono el cÃ³digo para obtener una tarjeta que nos informe en top 3 actual de las comunas con mayor cantidad de hogares afectados.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode m code-with-copy"><code class="sourceCode matlab"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="va">TOP3_Comunas</span> <span class="op">=</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="va">VAR</span> <span class="va">ComunasFiltradas</span> <span class="op">=</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">FILTER</span>(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">ALL</span>(<span class="va">clientes_afectados_tiempo_real</span>)<span class="op">,</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">clientes_afectados_tiempo_real</span>[<span class="va">Region_Corregida</span>] <span class="va">IN</span> <span class="va">VALUES</span>(<span class="va">clientes_afectados_tiempo_real</span>[<span class="va">Region_Corregida</span>])</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="va">VAR</span> <span class="va">ComunasGrouped</span> <span class="op">=</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">SUMMARIZE</span>(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">ComunasFiltradas</span><span class="op">,</span> </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">clientes_afectados_tiempo_real</span>[<span class="va">Comuna</span>]<span class="op">,</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"@Clientes_Afectados"</span><span class="op">,</span> <span class="va">SUM</span>(<span class="va">clientes_afectados_tiempo_real</span>[<span class="va">Clientes_Afectados</span>])</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="va">VAR</span> <span class="va">ComunasRanked</span> <span class="op">=</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">TOPN</span>(<span class="fl">3</span><span class="op">,</span> <span class="va">ComunasGrouped</span><span class="op">,</span> [<span class="op">@</span><span class="va">Clientes_Afectados</span>]<span class="op">,</span> <span class="va">DESC</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="va">RETURN</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">CONCATENATEX</span>(<span class="va">ComunasRanked</span><span class="op">,</span> <span class="va">clientes_afectados_tiempo_real</span>[<span class="va">Comuna</span>]<span class="op">,</span> <span class="st">", "</span>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/TOP_3.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
</section>
<section id="hogares-sin-luz-por-regiÃ³n" class="level3">
<h3 class="anchored" data-anchor-id="hogares-sin-luz-por-regiÃ³n">Hogares sin Luz por RegiÃ³n</h3>
<p>Este grÃ¡fico se crea con una visual de <em>Stacked bar chart</em>. UtilicÃ© en el eje y las Comunas, en el X la sumatoria de clientes afectados y la leyenda son las empresas elÃ©ctricas</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/stacked_bar.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
</section>
<section id="hogares-sin-luz-por-regiÃ³n-1" class="level3">
<h3 class="anchored" data-anchor-id="hogares-sin-luz-por-regiÃ³n-1">Hogares sin luz por RegiÃ³n</h3>
<p>Es una visualizaciÃ³n tipo <em>#Clustered bar chart#</em> similar al anterior con la diferencia que ahora es por Regiones y sin leyenda</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Hogares_region.png" class="img-fluid figure-img"></p>
<figcaption>Figura 4</figcaption>
</figure>
</div>
</section>
<section id="filtro-por-regiÃ³n" class="level3">
<h3 class="anchored" data-anchor-id="filtro-por-regiÃ³n">Filtro por RegiÃ³n</h3>
<p>Esta es una elecciÃ³n mÃ­a, podrÃ­as hacer filtros por comunas si deseas, incluso provincias si creas la columna. Lo utilicÃ© con la interfaz grÃ¡fica, en la opciÃ³n Filtro y en <em>field</em> las regiones, no la corregida, ya que son muy largos los nombres.</p>
</section>
<section id="listo" class="level3">
<h3 class="anchored" data-anchor-id="listo">Listo!</h3>
<p>Felicidades, si llegaste hasta acÃ¡ tienes un dashboard en condiciones, Â¿cierto? Pues no necesariamente. Es funcional, pero requiere de un estilado personalizado para verse mÃ¡s atrÃ¡ctivo y que llame la atenciÃ³n. DecidÃ­ no hacer un tutorial de esto ya que mi enfoque principal no es hacer un tutorial a fondo de PowerBI. De hecho, no hice grandes cambios, simplemente estandaricÃ© las fuentes, tamaÃ±os, colores, tÃ­tulos y poco mÃ¡s. Te puedo seÃ±alar que es muy importante que hayan buenos contrastes, que las letras sean legibles y que no hayan tantos colores: menos es mÃ¡s. De todas maneras, podrÃ¡s utilizar mi proyecto como plantilla para estilarlo a tu manera.</p>
</section>
</section>
</section>
<section id="conclusiones" class="level1">
<h1>Conclusiones</h1>
<p>A lo largo del tutorial hemos podido ahondar desde la extraccion de los datos con python, a la transformaciÃ³n y visualizaciÃ³n de estos con powerbi. Me gustarÃ­a seÃ±alar algunos aspectos a considerar del proyecto:</p>
<ul>
<li><p><strong>Playwright + pandas:</strong> combinaciÃ³n poderosa para extraer los datos y procesarlos, un factor clave para una correcta visualizaciÃ³n</p></li>
<li><p><strong>Powerbi:</strong> es una herramienta capaz de construir dashboards impactantes con un par de clicks y un poco de cÃ³digo, lo que es un aspecto positivo para mi experiencia considerando que es mi primera vez usÃ¡ndolo**</p></li>
<li><p><strong>Powerbi es un software de pago:</strong> la capa gratuita muchas veces nos limita la personalizaciÃ³n, escalabilidad del proyecto y procesos de automatizaciÃ³n, esto me hizo frenar mÃ¡s ideas que tenÃ­a en mente para este proyecto, ya que requerÃ­an de una licencia pagada, sin embargo, no niego que siga realizando proyectos con Powerbi debido a su facilidad y versatilidad, de hecho mi siguiente proyecto es utilizando powerbi + postgresql, asÃ­ que les invito a estar atentos</p></li>
<li><p><strong>Dependo de que el SEC funcione:</strong> si se corta la luz y la pÃ¡gina estÃ¡ caÃ­da, no podremos monitorear los casos, un aspecto que lamentablemente no puedo solucionar</p></li>
<li><p><strong>Base de datos histÃ³rica:</strong> si te fijas bien, hemos creado dos bases pero sÃ³lo nos hemos quedado con la de tiempo real. Bueno, esto se debe en parte a lo mencionado mÃ¡s arriba sobre los costes, sumado a que si bien son datos parecidos, el enfoque cambia bastante, ya que buscamos patrones en el tiempo y utilizamos otras mÃ©tricas para poder realizar el anÃ¡lisis, por lo que decidÃ­ profundizarlo de manera independiente a este proyecto. AÃºn asÃ­, la utilizamos en la medida para comparar respecto a la mediciÃ³n pasada</p></li>
<li><p><strong>Futuro del proyecto:</strong> me entusiasma la idea de poder automatizar un sistema de reporte periÃ³dico (horas, minutos, dÃ­as , mensuales, etc.) y poder ayudar a la gente a que podamos analizar los contenidos que ya nos presenta la SEC pero con un enfoque mÃ¡s didÃ¡ctico y aterrizado para los usuarios. Es una tarea pendiente que dejo la puerta abierta a las posibilidades**</p></li>
<li><p><strong>Python para todo:</strong> he pensado que si hago todo esto utilizando python, podrÃ­amos escalarlo gratuitamente. TambiÃ©n es una idea que tengo pensada a futuro y que puede beneficiar en mayor medida a las personas</p></li>
</ul>
<p>Gracias por llegar hasta aquÃ­, cualquier feedback siempre es bienvenido ğŸ’œ</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>